name: iOS CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  test:
    name: Run iOS Tests
    runs-on: macos-latest
    
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Select Xcode version
      run: |
        if [ -d "/Applications/Xcode.app/Contents/Developer" ]; then
          sudo xcode-select -s "/Applications/Xcode.app/Contents/Developer"
        else
          echo "No /Applications/Xcode.app found; using current selection: $(xcode-select -p)"
        fi
    
    - name: Show Xcode version
      run: xcodebuild -version

    - name: Select iOS Simulator destination
      run: |
        echo "Available simulators:"
        xcrun simctl list devices available | sed -n '1,120p'

        # Select a deterministic destination:
        # - Prefer an iPhone device
        # - From the newest available iOS runtime
        UDID=$(python3 - <<'PY'
        import json
        import re
        import subprocess

        raw = subprocess.check_output(["xcrun", "simctl", "list", "-j", "devices", "available"], text=True)
        data = json.loads(raw)

        def ios_version(runtime_id: str):
          # e.g. com.apple.CoreSimulator.SimRuntime.iOS-18-2
          m = re.search(r"iOS-(\d+)-(\d+)", runtime_id)
          if not m:
            return None
          return (int(m.group(1)), int(m.group(2)))

        devices_by_runtime = data.get("devices", {})
        ios_runtimes = [rt for rt in devices_by_runtime.keys() if ios_version(rt) is not None]
        ios_runtimes.sort(key=lambda rt: ios_version(rt), reverse=True)

        for rt in ios_runtimes:
          for dev in devices_by_runtime.get(rt, []):
            if not dev.get("isAvailable"):
              continue
            name = dev.get("name", "")
            if name.startswith("iPhone") and dev.get("udid"):
              print(dev["udid"])
              raise SystemExit(0)

        raise SystemExit(1)
        PY
        )
        if [ -z "$UDID" ]; then
          echo "Failed to select an available iPhone simulator UDID" >&2
          exit 1
        fi

        echo "Using iOS Simulator UDID: $UDID"
        echo "UDID=$UDID" >> "$GITHUB_ENV"
        echo "DESTINATION=platform=iOS Simulator,id=$UDID" >> "$GITHUB_ENV"

    - name: Boot simulator
      run: |
        # Ensure a clean, ready simulator to reduce flaky test failures.
        xcrun simctl shutdown all || true
        xcrun simctl boot "$UDID" || true
        xcrun simctl bootstatus "$UDID" -b
    
    - name: Build for testing
      working-directory: ios/App/LanguageSpeakingTrainer
      run: |
        xcodebuild build-for-testing \
          -project LanguageSpeakingTrainer.xcodeproj \
          -scheme LanguageSpeakingTrainer \
          -destination "$DESTINATION" \
          -derivedDataPath DerivedData
    
    - name: Run unit tests
      working-directory: ios/App/LanguageSpeakingTrainer
      run: |
        xcodebuild test-without-building \
          -project LanguageSpeakingTrainer.xcodeproj \
          -scheme LanguageSpeakingTrainer \
          -destination "$DESTINATION" \
          -derivedDataPath DerivedData \
          -only-testing:LanguageSpeakingTrainerTests \
          -resultBundlePath TestResults.xcresult
    
    - name: Run UI tests
      working-directory: ios/App/LanguageSpeakingTrainer
      run: |
        xcodebuild test-without-building \
          -project LanguageSpeakingTrainer.xcodeproj \
          -scheme LanguageSpeakingTrainer \
          -destination "$DESTINATION" \
          -derivedDataPath DerivedData \
          -only-testing:LanguageSpeakingTrainerUITests \
          -resultBundlePath UITestResults.xcresult
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          ios/App/LanguageSpeakingTrainer/TestResults.xcresult
          ios/App/LanguageSpeakingTrainer/UITestResults.xcresult
        if-no-files-found: ignore
  
  spec-coverage:
    name: Check Spec Coverage
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
    
    - name: Run spec coverage report
      run: python3 scripts/spec-coverage.py
